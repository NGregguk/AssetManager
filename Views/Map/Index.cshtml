@model asset_manager.ViewModels.FloorPlanMapViewModel
@{
    ViewData["Title"] = "Map";
    var canEditPins = User.IsInRole("Admin");
}

<section class="page-header">
    <div>
        <h1>Floor plan map</h1>
        <p class="muted">@(canEditPins ? "Click the map to place a pin and attach asset details." : "View asset locations on the floor plan.")</p>
    </div>
</section>

@if (Model.Plans.Count == 0)
{
    <div class="panel">
        <div class="empty-state">No floor plans found in wwwroot/floorplans.</div>
    </div>
    return;
}

<div class="panel map-controls">
    <form method="get" class="form-grid">
        <div class="form-field span-2">
            <label for="planId">Floor plan</label>
            <select id="planId" name="planId" class="form-select" onchange="this.form.submit()">
                @foreach (var plan in Model.Plans)
                {
                    <option value="@plan.Id" selected="@(Model.SelectedPlan?.Id == plan.Id)">
                        @plan.Name
                    </option>
                }
            </select>
        </div>
    </form>
    @if (Model.FilterAssetId.HasValue)
    {
        <div class="form-actions">
            <span class="muted">Filtered to a single asset.</span>
            <a class="button ghost small" asp-action="Index" asp-route-planId="@Model.SelectedPlan?.Id">Show all pins</a>
        </div>
    }
</div>

@if (Model.SelectedPlan != null)
{
    <div class="panel map-panel">
        <div class="map-canvas" data-plan-id="@Model.SelectedPlan.Id" data-can-edit="@canEditPins.ToString().ToLower()">
            @Html.AntiForgeryToken()
            <img src="@Model.SelectedPlan.ImagePath" alt="@Model.SelectedPlan.Name floor plan" class="map-image" />
            <div class="map-preview" id="mapPreview" aria-hidden="true"></div>
            @foreach (var pin in Model.Pins)
            {
                var label = pin.Asset?.Name ?? pin.Label ?? "Pin";
                var assetTag = pin.Asset?.Tag ?? string.Empty;
                var assetSerial = pin.Asset?.SerialNumber ?? string.Empty;
                var assetStatus = pin.Asset?.Status.ToString() ?? string.Empty;
                var assetLocation = pin.Asset?.Location?.Name ?? string.Empty;
                var assetCategory = pin.Asset?.Category?.Name ?? string.Empty;
                var assetModel = pin.Asset?.Model ?? string.Empty;
                var assetOs = pin.Asset?.OperatingSystem ?? string.Empty;
                <button type="button"
                        class="map-pin"
                        data-pin-id="@pin.Id"
                        data-label="@label"
                        data-tag="@assetTag"
                        data-serial="@assetSerial"
                        data-status="@assetStatus"
                        data-location="@assetLocation"
                        data-category="@assetCategory"
                        data-model="@assetModel"
                        data-os="@assetOs"
                        data-notes="@pin.Notes"
                        data-x="@pin.XPercent"
                        data-y="@pin.YPercent"
                        style="left:@pin.XPercent%; top:@pin.YPercent%;"
                        title="@label">
                    <span></span>
                </button>
            }
        </div>

        <aside class="panel map-sidebar" id="mapSidebar" aria-hidden="true">
            <div class="panel-header">
                <h2 id="sidebarTitle">Pin details</h2>
                <button type="button" class="button ghost small" id="closeSidebar">Close</button>
            </div>
            <dl class="details-grid">
                <div>
                    <dt>Asset</dt>
                    <dd id="sidebarAsset">-</dd>
                </div>
                <div>
                    <dt>Tag</dt>
                    <dd id="sidebarTag">-</dd>
                </div>
                <div>
                    <dt>Serial</dt>
                    <dd id="sidebarSerial">-</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd id="sidebarStatus">-</dd>
                </div>
                <div>
                    <dt>Location</dt>
                    <dd id="sidebarLocation">-</dd>
                </div>
                <div>
                    <dt>Category</dt>
                    <dd id="sidebarCategory">-</dd>
                </div>
                <div>
                    <dt>Model</dt>
                    <dd id="sidebarModel">-</dd>
                </div>
                <div>
                    <dt>OS</dt>
                    <dd id="sidebarOs">-</dd>
                </div>
                <div class="span-2">
                    <dt>Notes</dt>
                    <dd id="sidebarNotes">-</dd>
                </div>
                <div>
                    <dt>Position</dt>
                    <dd id="sidebarPosition">-</dd>
                </div>
            </dl>
        </aside>
    </div>

    <div class="content-grid">
        @if (canEditPins)
        {
            <div class="panel">
                <div class="panel-header">
                    <h2>Add pin</h2>
                    <span class="muted">Use the picker to set a position.</span>
                </div>
                <form asp-action="AddPin" method="post" class="form-grid">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="planId" value="@Model.SelectedPlan.Id" />
                    <input type="hidden" id="pinX" name="xPercent" />
                    <input type="hidden" id="pinY" name="yPercent" />
                    <div class="form-field span-2">
                        <div class="muted" id="pinHint">No location selected yet.</div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="button ghost small" id="pickLocation">Pick location</button>
                        <button type="button" class="button ghost small" id="clearLocation">Clear location</button>
                    </div>
                    <div class="form-field span-2">
                        <label for="assetId">Asset</label>
                        <select id="assetId" name="assetId" class="form-select">
                            <option value="">Select asset (optional)</option>
                            @foreach (var asset in Model.Assets)
                            {
                                <option value="@asset.Id">@asset.Name</option>
                            }
                        </select>
                    </div>
                    <div class="form-field span-2">
                        <label for="label">Label</label>
                        <input id="label" name="label" class="form-control" />
                    </div>
                    <div class="form-field span-2">
                        <label for="notes">Notes</label>
                        <textarea id="notes" name="notes" rows="3" class="form-control"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="button">Save pin</button>
                    </div>
                </form>
            </div>
        }

        <div class="panel">
            <div class="panel-header">
                <h2>Pins</h2>
                @if (Model.FilterAssetId.HasValue)
                {
                    <span class="muted">Filtered by asset</span>
                }
                else
                {
                    <span class="muted">@Model.Pins.Count total</span>
                }
            </div>
            @if (Model.Pins.Count == 0)
            {
                <div class="empty-state">No pins for this plan yet.</div>
            }
            else
            {
                <div class="timeline">
                    @foreach (var pin in Model.Pins)
                    {
                        <div class="timeline-item">
                            <div>
                                <div class="asset-name">@((pin.Asset?.Name) ?? pin.Label ?? "Pin")</div>
                                <div class="muted">@pin.Notes</div>
                            </div>
                            @if (canEditPins)
                            {
                                <form asp-action="DeletePin" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@pin.Id" />
                                    <input type="hidden" name="planId" value="@Model.SelectedPlan.Id" />
                                    <button type="submit" class="button danger small">Delete</button>
                                </form>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@section Scripts {
    <script>
        (() => {
            const map = document.querySelector(".map-canvas");
            if (!map) {
                return;
            }
            const canEditPins = map.dataset.canEdit === "true";
            const img = map.querySelector(".map-image");
            const pinX = document.getElementById("pinX");
            const pinY = document.getElementById("pinY");
            const token = map.querySelector('input[name="__RequestVerificationToken"]')?.value;
            const preview = document.getElementById("mapPreview");
            const pinHint = document.getElementById("pinHint");
            const pickLocation = document.getElementById("pickLocation");
            const clearLocation = document.getElementById("clearLocation");

            let draggingPin = null;
            let isPicking = false;

            const updatePinPosition = (event) => {
                if (!draggingPin || !img) {
                    return;
                }
                const rect = img.getBoundingClientRect();
                const x = ((event.clientX - rect.left) / rect.width) * 100;
                const y = ((event.clientY - rect.top) / rect.height) * 100;
                const clampedX = Math.max(0, Math.min(100, x));
                const clampedY = Math.max(0, Math.min(100, y));
                draggingPin.style.left = `${clampedX.toFixed(2)}%`;
                draggingPin.style.top = `${clampedY.toFixed(2)}%`;
                draggingPin.dataset.x = clampedX.toFixed(2);
                draggingPin.dataset.y = clampedY.toFixed(2);
            };

            if (canEditPins) {
                map.addEventListener("mousedown", (event) => {
                    const target = event.target.closest(".map-pin");
                    if (!target) {
                        return;
                    }
                    draggingPin = target;
                    event.preventDefault();
                });
            }

            const sidebar = document.getElementById("mapSidebar");
            const closeSidebar = document.getElementById("closeSidebar");
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = value && value.length > 0 ? value : "-";
                }
            };

            if (closeSidebar) {
                closeSidebar.addEventListener("click", () => {
                    if (sidebar) {
                        sidebar.classList.remove("open");
                        sidebar.setAttribute("aria-hidden", "true");
                    }
                });
            }

            if (canEditPins) {
                document.addEventListener("mousemove", updatePinPosition);
            }

            if (canEditPins) {
                document.addEventListener("mouseup", async () => {
                    if (!draggingPin) {
                        return;
                    }
                    const pinId = draggingPin.dataset.pinId;
                    const xValue = draggingPin.dataset.x;
                    const yValue = draggingPin.dataset.y;
                    draggingPin = null;

                    if (!pinId || !xValue || !yValue) {
                        return;
                    }

                    if (!token) {
                        return;
                    }

                    const body = new URLSearchParams();
                    body.set("id", pinId);
                    body.set("xPercent", xValue);
                    body.set("yPercent", yValue);

                    try {
                        await fetch("@Url.Action("UpdatePin", "Map")", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/x-www-form-urlencoded",
                                "RequestVerificationToken": token
                            },
                            body: body.toString()
                        });
                    } catch {
                        // ignore network errors for now
                    }
                });
            }

            const clearSelection = () => {
                pinX.value = "";
                pinY.value = "";
                if (preview) {
                    preview.classList.remove("active");
                    preview.setAttribute("aria-hidden", "true");
                }
                if (pinHint) {
                    pinHint.textContent = "No location selected yet.";
                }
            };

            if (pickLocation) {
                pickLocation.addEventListener("click", () => {
                    isPicking = true;
                    if (pinHint) {
                        pinHint.textContent = "Click the map to place the pin.";
                    }
                });
            }

            if (clearLocation) {
                clearLocation.addEventListener("click", () => {
                    isPicking = false;
                    clearSelection();
                });
            }

            map.addEventListener("click", (event) => {
                const pin = event.target.closest(".map-pin");
                if (pin) {
                    event.stopPropagation();
                    setText("sidebarAsset", pin.dataset.label);
                    setText("sidebarTag", pin.dataset.tag);
                    setText("sidebarSerial", pin.dataset.serial);
                    setText("sidebarStatus", pin.dataset.status);
                    setText("sidebarLocation", pin.dataset.location);
                    setText("sidebarCategory", pin.dataset.category);
                    setText("sidebarModel", pin.dataset.model);
                    setText("sidebarOs", pin.dataset.os);
                    setText("sidebarNotes", pin.dataset.notes);
                    const x = pin.dataset.x || "";
                    const y = pin.dataset.y || "";
                    setText("sidebarPosition", x && y ? `${x}% / ${y}%` : "-");
                    if (sidebar) {
                        sidebar.classList.add("open");
                        sidebar.setAttribute("aria-hidden", "false");
                    }
                    return;
                }

                if (!isPicking || !(event.target instanceof HTMLImageElement)) {
                    return;
                }
                const rect = img.getBoundingClientRect();
                const x = ((event.clientX - rect.left) / rect.width) * 100;
                const y = ((event.clientY - rect.top) / rect.height) * 100;
                pinX.value = x.toFixed(2);
                pinY.value = y.toFixed(2);
                if (preview) {
                    preview.style.left = `${x.toFixed(2)}%`;
                    preview.style.top = `${y.toFixed(2)}%`;
                    preview.classList.add("active");
                    preview.setAttribute("aria-hidden", "false");
                }
                if (pinHint) {
                    pinHint.textContent = `Selected location: ${x.toFixed(2)}% / ${y.toFixed(2)}%`;
                }
                isPicking = false;
            });
        })();
    </script>
}
