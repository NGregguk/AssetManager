@model Asset
@{
    ViewData["Title"] = "Asset details";
    Assignment? currentAssignment = null;
    foreach (var assignment in Model.Assignments)
    {
        if (assignment.ReturnedDate != null)
        {
            continue;
        }
        if (currentAssignment == null || assignment.AssignedDate > currentAssignment.AssignedDate)
        {
            currentAssignment = assignment;
        }
    }
}

<section class="page-header">
    <div>
        <h1>@Model.Name</h1>
        <p class="muted">@(string.IsNullOrWhiteSpace(Model.Tag) ? "No tag assigned" : $"Tag {Model.Tag}")</p>
    </div>
    <div class="header-actions">
        @if (User.IsInRole("Admin"))
        {
            <a class="button ghost" asp-action="Edit" asp-route-id="@Model.Id">Edit</a>
            <a class="button ghost" asp-action="Checkout" asp-route-id="@Model.Id">Check out / in</a>
        }
        <a class="button ghost show-on-map"
           asp-controller="Map"
           asp-action="Index"
           asp-route-assetId="@Model.Id"
           data-asset-name="@Model.Name"
           data-has-pin="@(Model.Pins.Any())">
            Show on map
        </a>
        @if (User.IsInRole("Admin"))
        {
            <a class="button danger" asp-action="Delete" asp-route-id="@Model.Id">Delete</a>
        }
    </div>
</section>

<div class="modal fade" id="mapLocationModal" tabindex="-1" aria-labelledby="mapLocationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapLocationModalLabel">Map pin missing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                This asset does not have a map pin yet.
            </div>
            <div class="modal-footer">
                <button type="button" class="button ghost" data-bs-dismiss="modal">Close</button>
                <a class="button" id="mapLocationMapLink">Open map</a>
            </div>
        </div>
    </div>
</div>

<section class="content-grid">
    <div class="panel">
        <div class="panel-header">
            <h2>Details</h2>
            <span class="pill">@Model.Status</span>
        </div>
        <dl class="details-grid">
            <div>
                <dt>Category</dt>
                <dd>@(Model.Category?.Name ?? "Uncategorised")</dd>
            </div>
            <div>
                <dt>Model template</dt>
                <dd>@(Model.AssetModel?.Name ?? "Not set")</dd>
            </div>
            <div>
                <dt>Location</dt>
                <dd>@(Model.Location?.Name ?? "Unassigned")</dd>
            </div>
            @if (!User.IsInRole("Admin"))
            {
                <div>
                    <dt>Current assignee</dt>
                    <dd>@(currentAssignment?.AssignedTo ?? "Unassigned")</dd>
                </div>
                <div>
                    <dt>Expected return</dt>
                    <dd>@(currentAssignment?.ExpectedReturnDate?.ToString("dd MMM yyyy") ?? "Not set")</dd>
                </div>
            }
            <div>
                <dt>Vendor</dt>
                <dd>@(Model.Vendor?.Name ?? "Not set")</dd>
            </div>
            <div>
                <dt>Computer name</dt>
                <dd>@(Model.ComputerName ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Manufacturer</dt>
                <dd>@(Model.Manufacturer ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Model</dt>
                <dd>@(Model.Model ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Architecture</dt>
                <dd>@(Model.Architecture ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>CPU</dt>
                <dd>@(Model.Cpu ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Cores</dt>
                <dd>@(Model.Cores?.ToString() ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Logical processors</dt>
                <dd>@(Model.LogicalProcessors?.ToString() ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Operating system</dt>
                <dd>@(Model.OperatingSystem ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>OS version</dt>
                <dd>@(Model.OsVersion ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>OS build</dt>
                <dd>@(Model.OsBuild ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>BIOS serial</dt>
                <dd>@(Model.BiosSerial ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>BIOS version</dt>
                <dd>@(Model.BiosVersion ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Install date</dt>
                <dd>@(Model.InstallDate?.ToString("dd MMM yyyy") ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Storage space</dt>
                <dd>@(Model.Space ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Total RAM (GB)</dt>
                <dd>@(Model.TotalRamGb?.ToString("0.##") ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Serial number</dt>
                <dd>@(Model.SerialNumber ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Purchase date</dt>
                <dd>@(Model.PurchaseDate?.ToString("dd MMM yyyy") ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Purchase cost</dt>
                <dd>@(Model.PurchaseCost?.ToString("C") ?? "Not recorded")</dd>
            </div>
            <div>
                <dt>Warranty expiry</dt>
                <dd>@(Model.WarrantyExpiry?.ToString("dd MMM yyyy") ?? "Not recorded")</dd>
            </div>
            <div class="span-2">
                <dt>Description</dt>
                <dd>@(string.IsNullOrWhiteSpace(Model.Description) ? "No description provided." : Model.Description)</dd>
            </div>
        </dl>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>Assignment history</h2>
            <a class="text-link" asp-action="Assignments" asp-route-id="@Model.Id">Full history</a>
        </div>
        <div class="timeline">
            @if (Model.Assignments.Count == 0)
            {
                <div class="empty-state">No assignment records yet.</div>
            }
            else
            {
                foreach (var item in Model.Assignments.Take(4))
                {
                    <div class="timeline-item">
                        <div>
                            <div class="asset-name">@item.AssignedTo</div>
                            <div class="muted">Assigned @item.AssignedDate.ToString("dd MMM yyyy")</div>
                        </div>
                        <div class="muted">@(
                            item.ReturnedDate == null ? "Active" : $"Returned {item.ReturnedDate.Value:dd MMM yyyy}"
                        )</div>
                    </div>
                }
            }
        </div>
    </div>
</section>

<section class="panel">
    <div class="panel-header">
        <h2>Attachments</h2>
        <span class="muted">@Model.Attachments.Count file(s)</span>
    </div>
    @if (Model.Attachments.Count == 0)
    {
        <div class="empty-state">No attachments yet.</div>
    }
    else
    {
        <div class="timeline">
            @foreach (var attachment in Model.Attachments.OrderByDescending(a => a.UploadedAt))
            {
                <div class="timeline-item">
                    <div>
                        <div class="asset-name">
                            <a href="@attachment.FilePath" target="_blank" rel="noopener">@attachment.OriginalFileName</a>
                        </div>
                        <div class="muted">
                            Uploaded @attachment.UploadedAt.ToString("dd MMM yyyy")
                            · @(attachment.SizeBytes / 1024) KB
                        </div>
                    </div>
                    @if (User.IsInRole("Admin"))
                    {
                        <form asp-action="DeleteAttachment" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <input type="hidden" name="attachmentId" value="@attachment.Id" />
                            <button type="submit" class="button danger small">Delete</button>
                        </form>
                    }
                </div>
            }
        </div>
    }
    @if (User.IsInRole("Admin"))
    {
        <form asp-action="UploadAttachment" method="post" enctype="multipart/form-data" class="form-grid">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.Id" />
            <div class="form-field span-2">
                <label for="attachmentFile">Add attachment</label>
                <input id="attachmentFile" name="file" type="file" class="form-control" />
            </div>
            <div class="form-actions">
                <button type="submit" class="button">Upload</button>
            </div>
        </form>
    }
</section>

<section class="panel">
    <div class="panel-header">
        <h2>Maintenance log</h2>
        <a class="text-link" asp-action="Maintenance" asp-route-id="@Model.Id">View log</a>
    </div>
    <div class="timeline">
        @if (Model.MaintenanceRecords.Count == 0)
        {
            <div class="empty-state">No maintenance logged for this asset.</div>
        }
        else
        {
            foreach (var record in Model.MaintenanceRecords.Take(4))
            {
                <div class="timeline-item">
                    <div>
                        <div class="asset-name">@record.Summary</div>
                        <div class="muted">@record.MaintenanceDate.ToString("dd MMM yyyy")</div>
                    </div>
                    <div class="muted">@((record.Cost?.ToString("C")) ?? "No cost")</div>
                </div>
            }
        }
    </div>
</section>

<section class="panel">
    <div class="panel-header">
        <h2>Activity</h2>
        <span class="muted">@Model.Activities.Count item(s)</span>
    </div>
    @if (Model.Activities.Count == 0)
    {
        <div class="empty-state">No activity recorded yet.</div>
    }
    else
    {
        <div class="timeline">
            @foreach (var item in Model.Activities)
            {
                <div class="timeline-item">
                    <div>
                        <div class="asset-name">@item.Message</div>
                        <div class="muted">@item.CreatedAt.ToString("dd MMM yyyy")</div>
                    </div>
                    <div class="muted">@((string.IsNullOrWhiteSpace(item.PerformedBy) ? "System" : item.PerformedBy))</div>
                </div>
            }
        </div>
    }
</section>

@section Scripts {
    <script>
        (() => {
            const modalEl = document.getElementById("mapLocationModal");
            if (!modalEl || typeof bootstrap === "undefined") {
                return;
            }
            const mapLink = document.getElementById("mapLocationMapLink");
            const modal = new bootstrap.Modal(modalEl);

            document.querySelectorAll(".show-on-map").forEach((link) => {
                link.addEventListener("click", (event) => {
                    const hasPin = link.dataset.hasPin === "True" || link.dataset.hasPin === "true";
                    if (hasPin) {
                        return;
                    }
                    event.preventDefault();
                    const assetName = link.dataset.assetName || "this asset";
                    const body = modalEl.querySelector(".modal-body");
                    if (body) {
                        body.textContent = `${assetName} does not have a map pin yet.`;
                    }
                    if (mapLink) {
                        const href = link.getAttribute("href") || "";
                        mapLink.href = href;
                    }
                    modal.show();
                });
            });
        })();
    </script>
}

